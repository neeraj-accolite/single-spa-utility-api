#latest 2.1 version of CircleCI pipeline process engine.
version: 2.1
orbs:
  node: circleci/node@5
  heroku: circleci/heroku@1.2.6
commands:
  env-setup:
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/jobs-steps/#jobs-overview & https://circleci.com/docs/configuration-reference/#jobs
jobs:
  build-app:
    executor: node/default
    steps:
      - env-setup
      - run:
          name: Project is Building
          command: npm run build
      - persist_to_workspace: 
          root: ~/project
          paths:
            - .
            - echo-output
  run-tests:
    executor: node/default
    parallelism: 2
    steps:
      - attach_workspace:
        at: ~/project
      - run:
          name: Run Tests
          command: npm test
  deploy-build:
    executor: node/default
    steps:
      - attach_workspace:
          at: ~/project
      - heroku/deploy-via-git:
          force: true  
workflows:
  build-and-deploy:
    jobs:
      - build-app
      - run-tests
          requires:
            - build-app
      - hold-for-approval:
          type: approval
          requires:
            - run-tests
      - deploy-build:
          requires:
            - hold-for-approval
          filters:
            branches:
              only: main #deploy only for the main branch.